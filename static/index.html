<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attention OS · 注意力管理</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    <!-- Screen blur overlay for break enforcement -->
    <div class="blur-overlay" id="blurOverlay">
        <div style="font-size:40px;">🧘</div>
        <div class="blur-msg">休息时间<br>让你的眼睛和大脑放松一下</div>
        <div class="big-timer" id="blurTimer">05:00</div>
        <div class="blur-msg" style="font-size:14px;" id="blurTip">深呼吸，看看远处，站起来走动一下</div>
        <button class="skip-btn" id="blurSkipBtn" onclick="skipBreak()">我需要继续工作 →</button>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                    <h2 id="reportTitle">📊 每日复盘</h2>
                    <div class="date-sub" id="reportDate"></div>
                </div>
                <button class="btn btn-sm" onclick="closeReport()">✕ 关闭</button>
            </div>
            <div id="reportContent"></div>
        </div>
    </div>

    <!-- ====== DAILY BRIEFING MODAL ====== -->
    <div class="modal-overlay" id="briefingModal">
        <div class="modal" style="max-width:580px;">
            <div style="text-align:center;padding:8px 0 4px;">
                <div style="font-size:36px;">☀️</div>
                <h2 style="font-size:22px;margin:8px 0 2px;" id="briefingGreeting">早上好</h2>
                <div class="date-sub" id="briefingDate" style="margin-bottom:16px;"></div>
            </div>

            <!-- Deadline 提醒区域 -->
            <div id="briefingAlerts" style="margin-bottom:16px;"></div>

            <!-- 今日目标输入 -->
            <div style="margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;margin-bottom:10px;color:var(--text-primary);">🎯 你今天最想完成什么？</div>
                <div id="briefingGoalInputs">
                    <div style="display:flex;gap:8px;margin-bottom:8px;">
                        <input type="text" class="todo-input briefing-goal-input" placeholder="今日最重要的任务..." style="flex:1;" data-index="0" onkeydown="if(event.key==='Enter'){event.preventDefault();addBriefingGoalInput();}">
                    </div>
                </div>
                <button class="btn btn-sm" style="font-size:12px;color:var(--text-muted);" onclick="addBriefingGoalInput()">+ 再加一个目标</button>
            </div>

            <!-- 提交按钮 -->
            <div style="display:flex;gap:10px;justify-content:center;padding-top:8px;">
                <button class="btn btn-green" onclick="submitBriefing()" style="min-width:160px;">✅ 开始今天的工作</button>
                <button class="btn btn-sm" onclick="dismissBriefing()" style="color:var(--text-muted);">跳过</button>
            </div>
        </div>
    </div>

    <!-- ====== EVENING REVIEW MODAL ====== -->
    <div class="modal-overlay" id="eveningReviewModal">
        <div class="modal" style="max-width:620px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                    <h2 style="font-size:20px;" id="reviewTitle">🌙 一日回顾</h2>
                    <div class="date-sub" id="reviewDate"></div>
                </div>
                <button class="btn btn-sm" onclick="document.getElementById('eveningReviewModal').classList.remove('show')">✕ 关闭</button>
            </div>
            <div id="eveningReviewContent" style="margin-top:16px;"></div>
        </div>
    </div>

    <!-- First-use guide -->
    <div class="modal-overlay" id="onboardingModal">
        <div class="modal onboarding-modal">
            <div class="onboarding-head">
                <div>
                    <div class="onboarding-kicker">欢迎来到 Attention OS</div>
                    <h2>3 分钟上手，让系统真正帮你专注</h2>
                    <div class="date-sub">建议首次使用按顺序完成下面三步。</div>
                </div>
                <button class="btn btn-sm" onclick="closeOnboarding()">稍后</button>
            </div>
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="step-num">1</div>
                    <div>
                        <div class="step-title">添加今天最重要的任务</div>
                        <div class="step-desc">进入「任务」页，输入自然语言任务，系统会自动识别优先级和截止时间。</div>
                    </div>
                    <button class="btn btn-green btn-sm" onclick="jumpToTab('todo')">去添加</button>
                </div>
                <div class="onboarding-step">
                    <div class="step-num">2</div>
                    <div>
                        <div class="step-title">开启番茄钟节奏</div>
                        <div class="step-desc">进入「番茄钟」，设定一个本次专注任务，点击开始并让系统提醒你休息。</div>
                    </div>
                    <button class="btn btn-amber btn-sm" onclick="jumpToTab('pomodoro')">去启动</button>
                </div>
                <div class="onboarding-step">
                    <div class="step-num">3</div>
                    <div>
                        <div class="step-title">配置 AI 服务</div>
                        <div class="step-desc">在「设置」里填入 API Key，启用你偏好的模型来获得智能建议与解析。</div>
                    </div>
                    <button class="btn btn-blue btn-sm" onclick="jumpToTab('settings')">去配置</button>
                </div>
            </div>
            <div class="onboarding-foot">
                <label><input type="checkbox" id="onboardingDontShow"> 不再自动显示</label>
                <button class="btn btn-green" onclick="finishOnboarding()">完成，开始使用</button>
            </div>
        </div>
    </div>

    <div class="app">
        <header>
            <div class="logo">
                <h1>Attention OS</h1>
                <span class="ver">v4.0</span>
            </div>
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="切换日间/夜间模式">
                    <span class="icon-sun">☀️</span>
                    <span class="icon-moon">🌙</span>
                </button>
                <button class="btn btn-sm btn-blue" onclick="openReport()">📊 日报</button>
                <div class="live-dot" id="statusDot"></div>
                <span class="header-time" id="statusText">连接中...</span>
            </div>
        </header>

        <!-- Nav Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab" onclick="switchTab('dashboard', this)">📊 仪表盘</button>
            <button class="nav-tab" onclick="switchTab('checkin', this)">⏰ 签到</button>
            <button class="nav-tab" onclick="switchTab('pomodoro', this)">🍅 番茄钟</button>
            <button class="nav-tab active" onclick="switchTab('todo', this)">📋 任务</button>
            <button class="nav-tab" onclick="switchTab('plugins', this)">🧩 插件</button>
            <button class="nav-tab" onclick="switchTab('settings', this)">⚙️ 设置</button>
        </div>

        <!-- ==================== TAB: DASHBOARD ==================== -->
        <div class="tab-content" id="tab-dashboard">
            <!-- Top metric cards -->
            <div class="g4">
                <div class="card">
                    <div class="card-title">今日开工</div>
                    <div class="card-value" id="workStartTime" style="font-size:22px;color:var(--blue);">--:--</div>
                    <div class="card-sub" id="workStartCompare">--</div>
                </div>
                <div class="card">
                    <div class="card-title">当前状态</div>
                    <div class="card-value" id="currentEngagement" style="font-size:22px;">--</div>
                    <div class="card-sub" id="currentApp">--</div>
                </div>
                <div class="card">
                    <div class="card-title">今日生产率</div>
                    <div class="card-value" id="productiveRatio" style="color:var(--green);">--%</div>
                    <div class="card-sub" id="totalRecords">-- 条记录</div>
                </div>
                <div class="card">
                    <div class="card-title">今日分心率</div>
                    <div class="card-value" id="distractedRatio" style="color:var(--red);">--%</div>
                    <div class="card-sub" id="distractionStreak">--</div>
                </div>
            </div>

            <!-- Timeline + realtime status -->
            <div class="g2">
                <div class="card">
                    <div class="card-title">今日时间线</div>
                    <div class="timeline-wrap"><div class="timeline" id="timeline"></div></div>
                    <div class="tl-legend">
                        <span><span style="color:var(--green);">●</span> 专注</span>
                        <span><span style="color:var(--amber);">●</span> 一般</span>
                        <span><span style="color:var(--red);">●</span> 分心</span>
                        <span><span style="color:var(--text-muted);">●</span> 空闲</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">实时状态</div>
                    <div class="status-row"><span class="sr-label">工作状态</span><span class="badge badge-amber" id="workStatus">--</span></div>
                    <div class="status-row"><span class="sr-label">参与类型</span><span class="badge badge-blue" id="userEngagement">--</span></div>
                    <div class="status-row"><span class="sr-label">焦点窗口</span><span class="sr-value" id="focusWindow" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">--</span></div>
                    <div class="status-row"><span class="sr-label">空闲时长</span><span class="sr-value" id="idleDuration">-- 秒</span></div>
                </div>
            </div>

            <!-- Neural recovery panel -->
            <div class="card" id="recoveryCard" style="margin-bottom:20px; display:none;">
                <div class="card-title">🧠 神经恢复状态</div>
                <div class="recovery-panel">
                    <div class="neuro-bars">
                        <div class="neuro-row">
                            <div class="neuro-icon">🔋</div>
                            <div class="neuro-label">神经递质</div>
                            <div class="neuro-track"><div class="neuro-fill nt" id="ntBar" style="width:0%"></div></div>
                            <div class="neuro-pct" id="ntPct">0%</div>
                        </div>
                        <div class="neuro-row">
                            <div class="neuro-icon">🧹</div>
                            <div class="neuro-label">注意力残留</div>
                            <div class="neuro-track"><div class="neuro-fill ar" id="arBar" style="width:0%"></div></div>
                            <div class="neuro-pct" id="arPct">0%</div>
                        </div>
                        <div class="neuro-row">
                            <div class="neuro-icon">📌</div>
                            <div class="neuro-label">任务上下文</div>
                            <div class="neuro-track"><div class="neuro-fill ci" id="ciBar" style="width:100%"></div></div>
                            <div class="neuro-pct" id="ciPct">100%</div>
                        </div>
                    </div>
                    <div class="recovery-msg" id="recoveryMsg" style="display:none;"></div>
                </div>
            </div>

            <!-- Work Start Time History -->
            <div class="card" style="margin-bottom:20px;">
                <div class="card-title">⏰ 开工时间记录</div>
                <div style="display:flex;gap:16px;margin-bottom:12px;font-size:13px;color:var(--text-secondary);">
                    <span>工作日平均: <b id="avgWorkday" style="color:var(--blue);">--:--</b></span>
                    <span>休息日平均: <b id="avgWeekend" style="color:var(--purple);">--:--</b></span>
                </div>
                <div id="workStartHistory" style="display:flex;gap:3px;flex-wrap:wrap;align-items:flex-end;min-height:80px;"></div>
                <div style="display:flex;gap:14px;margin-top:8px;font-size:11px;color:var(--text-muted);">
                    <span><span style="color:var(--blue);">●</span> 工作日</span>
                    <span><span style="color:var(--purple);">●</span> 休息日</span>
                    <span><span style="color:var(--text-muted);">●</span> 无记录</span>
                </div>
            </div>

            <!-- Charts -->
            <div class="g3">
                <div class="card"><div class="card-title">状态分布</div><div class="chart-box"><canvas id="statusChart"></canvas></div></div>
                <div class="card"><div class="card-title">每小时效率</div><div class="chart-box"><canvas id="hourlyChart"></canvas></div></div>
                <div class="card"><div class="card-title">本周趋势</div><div class="chart-box"><canvas id="weeklyChart"></canvas></div></div>
            </div>
            <div class="g2">
                <div class="card"><div class="card-title">活动率曲线</div><div class="chart-box"><canvas id="activityChart"></canvas></div></div>
                <div class="card"><div class="card-title">应用使用排行</div><div class="app-list" id="appList"></div></div>
            </div>
        </div>

        <!-- ==================== TAB: CHECKIN ==================== -->
        <div class="tab-content" id="tab-checkin">
            <div class="g2e">
                <!-- 左侧：签到输入 + 今日时间线 -->
                <div class="card">
                    <div class="card-title">⏰ 快速签到</div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <input type="text" class="todo-input" id="checkinInput" placeholder="过去一小时你在做什么？" onkeydown="if(event.key==='Enter')submitWebCheckin()" style="flex:1;">
                        <select id="checkinFeeling" class="setting-input" style="width:auto;min-width:100px;">
                            <option value="great">🔥 极佳</option>
                            <option value="good">😊 不错</option>
                            <option value="normal" selected>😐 一般</option>
                            <option value="tired">😴 有点累</option>
                            <option value="bad">😫 很差</option>
                        </select>
                        <button class="btn btn-green btn-sm" onclick="submitWebCheckin()">签到</button>
                    </div>
                    <div class="card-title" style="margin-top:16px;">今日签到时间线</div>
                    <div id="checkinTimeline" style="max-height:420px;overflow-y:auto;"></div>
                    <div style="margin-top:12px;display:flex;gap:8px;">
                        <button class="btn btn-sm btn-blue" onclick="triggerCheckinPopup()">📢 弹窗签到</button>
                        <button class="btn btn-sm btn-amber" onclick="generateSummaryNow()">🌙 生成晚间总结</button>
                        <button class="btn btn-sm btn-green" onclick="openEveningReview()">📊 一日回顾</button>
                    </div>
                </div>
                <!-- 右侧：统计 + 晚间总结 -->
                <div class="card">
                    <div class="card-title">📊 签到统计</div>
                    <div class="status-row"><span class="sr-label">今日签到</span><span class="sr-value" id="checkinCount">0</span></div>
                    <div class="status-row"><span class="sr-label">跳过次数</span><span class="sr-value" id="checkinSkipped">0</span></div>
                    <div class="status-row"><span class="sr-label">下次签到</span><span class="sr-value" id="checkinNext">--</span></div>
                    <div class="status-row"><span class="sr-label">签到状态</span><span class="sr-value" id="checkinRunning">--</span></div>

                    <div class="card-title" style="margin-top:20px;">🌙 晚间总结</div>
                    <div id="eveningSummaryBox" style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
                        <span style="color:var(--text-muted);">暂无总结，到达设定时间后自动生成</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB: POMODORO ==================== -->
        <div class="tab-content" id="tab-pomodoro">
            <div class="g2e">
                <div class="card" style="display:flex;flex-direction:column;align-items:center;">
                    <div class="card-title" style="align-self:flex-start;">番茄钟</div>
                    <!-- Focus Task Selector -->
                    <div id="pomoFocusArea" style="align-self:stretch;margin-bottom:12px;">
                        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">🎯 本次专注任务</div>
                        <select id="pomoFocusSelect" class="setting-input" style="width:100%;font-size:13px;font-family:var(--sans);">
                            <option value="">（无绑定，自由专注）</option>
                        </select>
                        <div id="pomoCurrentFocus" style="display:none;text-align:center;padding:8px 12px;margin-top:8px;background:var(--green-dim);border-radius:var(--radius-sm);font-size:13px;color:var(--green);font-weight:500;"></div>
                    </div>
                    <div class="pomo-ring-container">
                        <div class="pomo-ring">
                            <svg viewBox="0 0 200 200">
                                <circle class="bg" cx="100" cy="100" r="88"/>
                                <circle class="fg" id="pomoRing" cx="100" cy="100" r="88"
                                    stroke="var(--green)" stroke-dasharray="553" stroke-dashoffset="0"/>
                            </svg>
                            <div class="pomo-center">
                                <div class="pomo-time" id="pomoTime">25:00</div>
                                <div class="pomo-label" id="pomoLabel">空闲</div>
                            </div>
                        </div>
                        <div class="pomo-cycles" id="pomoCycles"></div>
                        <div class="pomo-btns" id="pomoBtns">
                            <button class="btn btn-green" onclick="pomoStartWithTask()">▶ 开始专注</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">今日统计</div>
                    <div class="status-row"><span class="sr-label">完成番茄</span><span class="sr-value" id="pomoCompleted">0</span></div>
                    <div class="status-row"><span class="sr-label">累计专注</span><span class="sr-value" id="pomoWorkMin">0 分钟</span></div>
                    <div class="status-row"><span class="sr-label">累计休息</span><span class="sr-value" id="pomoBreakMin">0 分钟</span></div>
                    <div class="status-row"><span class="sr-label">跳过休息</span><span class="sr-value" id="pomoSkipped">0 次</span></div>

                    <!-- Focus Session Log -->
                    <div class="card-title" style="margin-top:16px;">📋 专注记录</div>
                    <div id="pomoSessionLog" style="max-height:180px;overflow-y:auto;">
                        <div style="font-size:12px;color:var(--text-muted);padding:4px 0;">今日尚无专注记录</div>
                    </div>

                    <div style="margin-top:16px;">
                        <div class="card-title">番茄钟设置</div>
                        <div class="setting-group" style="margin-bottom:10px;">
                            <label class="setting-label">工作时长（分钟）</label>
                            <input type="number" class="setting-input" id="pomoWorkMins" value="25" min="5" max="60" onchange="updatePomoSettings()">
                        </div>
                        <div class="setting-group" style="margin-bottom:10px;">
                            <label class="setting-label">短休息（分钟）</label>
                            <input type="number" class="setting-input" id="pomoShortBreak" value="5" min="1" max="15" onchange="updatePomoSettings()">
                        </div>
                        <div class="setting-group" style="margin-bottom:10px;">
                            <label class="setting-label">长休息（分钟）</label>
                            <input type="number" class="setting-input" id="pomoLongBreak" value="15" min="5" max="30" onchange="updatePomoSettings()">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">强制休息（屏幕模糊）</label>
                            <label class="switch"><input type="checkbox" id="pomoForceBreak" checked onchange="updatePomoSettings()"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB: TODO ==================== -->
        <div class="tab-content active" id="tab-todo">
            <div class="quickstart-banner">
                <div>
                    <div class="quickstart-title">✨ 今天先做这三件事：写任务 → 开番茄钟 → 查看仪表盘</div>
                    <div class="quickstart-sub">如果你是第一次使用，建议先运行引导，3 分钟即可完成基础配置。</div>
                </div>
                <div class="quickstart-actions">
                    <button class="btn btn-sm" onclick="openOnboarding()">新手引导</button>
                    <button class="btn btn-sm btn-blue" onclick="jumpToTab('dashboard')">查看仪表盘</button>
                </div>
            </div>
            <div class="g2e">
                <div class="card">
                    <div class="todo-header">
                        <div class="card-title" style="margin-bottom:0;">待办事项</div>
                        <div class="todo-stats" id="todoStats"></div>
                    </div>
                    <div class="todo-input-row">
                        <input type="text" class="todo-input" id="todoSmartInput" placeholder="输入任务，如：明天下午前完成项目报告，紧急" onkeydown="if(event.key==='Enter')smartAddTodo()" style="flex:1;">
                        <button class="btn btn-green btn-sm" onclick="smartAddTodo()" id="smartAddBtn">＋</button>
                        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="语音输入">🎙</button>
                    </div>
                    <div class="voice-hint" id="voiceHint">🎙 正在录音...说完后自动识别</div>
                    <!-- 智能解析预览 -->
                    <div class="smart-parse-preview" id="parsePreview" style="display:none;">
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">🤖 智能解析结果：</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                            <span class="parse-tag" id="previewTitle" style="font-weight:600;"></span>
                            <span class="parse-tag" id="previewDeadline" style="display:none;"></span>
                            <span class="parse-tag" id="previewPriority" style="display:none;"></span>
                            <span class="parse-tag-list" id="previewTags"></span>
                        </div>
                        <div style="display:flex;gap:6px;margin-top:6px;">
                            <button class="btn btn-green btn-sm" onclick="confirmSmartAdd()" style="font-size:11px;padding:2px 10px;">确认添加</button>
                            <button class="btn btn-sm" onclick="hidePreview()" style="font-size:11px;padding:2px 10px;background:var(--card-bg);border:1px solid var(--border);color:var(--text-secondary);">取消</button>
                        </div>
                    </div>
                    <div class="todo-list" id="todoList"></div>
                </div>
                <div class="card">
                    <!-- 今日目标（来自 Briefing）-->
                    <div class="card-title">🎯 今日目标</div>
                    <div id="todayGoalsPanel" style="margin-bottom:16px;"></div>
                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <input type="text" class="todo-input" id="addGoalInput" placeholder="追加一个目标..." style="flex:1;font-size:13px;" onkeydown="if(event.key==='Enter')addGoalFromPanel()">
                        <button class="btn btn-green btn-sm" onclick="addGoalFromPanel()">+</button>
                    </div>

                    <div class="card-title">任务概览</div>
                    <div class="status-row"><span class="sr-label">总任务</span><span class="sr-value" id="todoTotal">0</span></div>
                    <div class="status-row"><span class="sr-label">待完成</span><span class="sr-value" id="todoPending">0</span></div>
                    <div class="status-row"><span class="sr-label">今日到期</span><span class="sr-value" id="todoDueToday" style="color:var(--amber)">0</span></div>
                    <div class="status-row"><span class="sr-label">已逾期</span><span class="sr-value" id="todoOverdue" style="color:var(--red)">0</span></div>
                    <div class="status-row"><span class="sr-label">已完成</span><span class="sr-value" id="todoCompleted" style="color:var(--green)">0</span></div>
                    <div style="margin-top:16px;">
                        <div class="card-title">💡 智能输入说明</div>
                        <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;">
                            直接用自然语言描述任务，AI 自动解析：<br>
                            <span style="color:var(--text-primary);">「明天下午前完成项目报告，紧急」</span><br>
                            <span style="color:var(--text-primary);">「下周五之前 review 小王的代码」</span><br>
                            <span style="color:var(--text-primary);">「买牙膏和洗衣液，不急」</span><br>
                            <span style="color:var(--text-primary);">「3天内学完 PyTorch 教程」</span><br>
                            系统自动提取 <b>标题、截止日期、优先级、标签</b>。<br>
                            也支持 🎙 语音输入（Chrome/Edge）。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB: SETTINGS ==================== -->
        <!-- ==================== TAB: PLUGINS ==================== -->
        <div class="tab-content" id="tab-plugins">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <div>
                    <div style="font-size:16px;font-weight:700;color:var(--text-primary);">插件管理</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">安装、启用和配置插件来扩展 Attention OS 功能</div>
                </div>
                <button class="btn btn-sm btn-blue" onclick="discoverPlugins()">🔄 重新扫描</button>
            </div>

            <div id="pluginsList" style="display:grid;gap:12px;">
                <div class="card" style="text-align:center;color:var(--text-muted);padding:40px;">
                    加载中...
                </div>
            </div>

            <!-- Event History (debug) -->
            <details style="margin-top:24px;">
                <summary style="font-size:13px;color:var(--text-muted);cursor:pointer;user-select:none;">
                    🔧 事件总线调试
                </summary>
                <div class="card" style="margin-top:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div class="card-title" style="margin:0;">最近事件</div>
                        <button class="btn btn-sm" onclick="loadEventHistory()">刷新</button>
                    </div>
                    <div id="eventHistoryList" style="font-size:12px;font-family:'JetBrains Mono',monospace;max-height:300px;overflow-y:auto;">
                        <div style="color:var(--text-muted);">点击刷新查看事件</div>
                    </div>
                </div>
            </details>
        </div>

        <!-- ==================== TAB: SETTINGS ==================== -->
        <div class="tab-content" id="tab-settings">
            <div class="g2e">
                <div class="card">
                    <div class="card-title">🎨 外观</div>
                    <div class="settings-grid" style="margin-bottom:20px;">
                        <div class="setting-group">
                            <label class="setting-label">夜间模式</label>
                            <label class="switch"><input type="checkbox" id="darkModeToggle" checked onchange="toggleThemeFromSetting()"><span class="slider"></span></label>
                        </div>
                    </div>

                    <!-- ====== API Key 管理 ====== -->
                    <div class="card-title" style="margin-top:20px;">🔑 AI 模型 API 配置</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6;">
                        配置不同 AI 提供商的 API Key。输入后点击「测试」验证连通性，然后「激活」你想使用的提供商。
                    </div>
                    <div id="apiProvidersList">
                        <div style="color:var(--text-muted);font-size:13px;padding:12px 0;">加载中...</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">📊 每日报告</div>
                    <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;margin-bottom:16px;">
                        系统会在每天首次启动时自动生成昨日报告，<br>包含效率统计、应用分布、与平均值对比和个性化建议。
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-green" onclick="openReport()">查看最新日报</button>
                        <button class="btn btn-amber" onclick="generateReport()">手动生成今日报告</button>
                    </div>

                    <div class="card-title" style="margin-top:24px;">⏰ 每小时签到</div>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">启用</label>
                            <label class="switch"><input type="checkbox" id="checkinEnabled" checked onchange="toggleCheckin()"><span class="slider"></span></label>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">间隔（分钟）</label>
                            <input type="number" class="setting-input" id="checkinInterval" min="15" max="120" value="60" onchange="updateCheckinSettings()">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">开始时间</label>
                            <input type="number" class="setting-input" id="checkinStartHour" min="0" max="23" value="9" onchange="updateCheckinSettings()">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">结束时间</label>
                            <input type="number" class="setting-input" id="checkinEndHour" min="0" max="23" value="23" onchange="updateCheckinSettings()">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">晚间总结时间</label>
                            <input type="number" class="setting-input" id="checkinSummaryHour" min="18" max="23" value="22" onchange="updateCheckinSettings()">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">提示音</label>
                            <label class="switch"><input type="checkbox" id="checkinSound" checked onchange="updateCheckinSettings()"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="status-row" style="margin-top:12px;">
                        <span class="sr-label status-text" id="checkinStatusText">--</span>
                        <button class="btn btn-sm btn-blue" onclick="triggerCheckinPopup()">测试弹窗</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== FLOATING CHAT WIDGET ==================== -->
    <button class="chat-fab" id="chatFab" onclick="toggleChat()" title="对话助手">💬</button>

    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span class="chat-header-title">Attention OS 助手</span>
            <button style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;" onclick="toggleChat()">✕</button>
        </div>
        <div class="chat-mode-tabs">
            <button class="chat-mode-tab" data-mode="memo" onclick="setChatMode('memo')">📝 随手记</button>
            <button class="chat-mode-tab active" data-mode="ask_ai" onclick="setChatMode('ask_ai')">🤖 问 AI</button>
            <button class="chat-mode-tab" data-mode="focus" onclick="setChatMode('focus')">🎯 专注模式</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-msg ai">你好！我是 Attention OS 助手。<br>选择模式后开始对话吧 ~<span class="msg-time"></span></div>
        </div>
        <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="问 AI 任何问题..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">➤</button>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        // Init: load API providers on settings tab
        var _origSwitchTab = switchTab;
        switchTab = function(name, el) {
            _origSwitchTab(name, el);
            if (name === 'settings') loadAPIProviders();
        };
        // Load providers on first visit to settings
        document.addEventListener('DOMContentLoaded', function() {
            // Preload API settings data
            setTimeout(loadAPIProviders, 1000);
        });
    </script>
</body>
</html>
